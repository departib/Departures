<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inflatabubble Departures</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body{background:#111;color:#ffcc00;font-family:monospace;margin:0}
    h1{margin:20px 0;text-align:center;font-size:3em}
    table{width:100%;border-collapse:collapse;font-size:2em;table-layout:fixed}
    /* Wider Status column to keep long text on one line */
    col.time{width:20%} col.party{width:55%} col.status{width:25%}
    thead th{background:#222}
    th,td{padding:20px;border-bottom:2px solid #333;vertical-align:middle}
    th:nth-child(1),td:nth-child(1){text-align:left;padding-left:40px}
    th:nth-child(2),td:nth-child(2){text-align:left}
    th:nth-child(3),td:nth-child(3){text-align:right;padding-right:40px;white-space:nowrap}

    /* Status colours */
    .status-now{color:#00e676}      /* green */
    .status-closed{color:#ff5252}   /* red  */
    .status-celebrate{color:#ffcc00}/* yellow (default) */

    /* Split-flap animation on inner span */
    .flap{display:inline-block;transform-origin:bottom;animation:flap .6s ease}
    @keyframes flap{0%{transform:rotateX(90deg);opacity:0}100%{transform:rotateX(0);opacity:1}}

    /* Gentle pulse for "Now Boarding" after the initial flap */
    .flap.status-now{animation:flap .6s ease, pulse 3s ease-in-out .6s infinite}
    @keyframes pulse{0%{opacity:.55}50%{opacity:1}100%{opacity:.55}}

    /* Sound gate (for the flip beep) */
    #soundGate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.88);
      color:#ffcc00;font-family:monospace;z-index:9999}
    #soundGate .wrap{display:grid;gap:12px;place-items:center}
    #soundGate button{font-size:1.1rem;padding:12px 18px;border:2px solid #ffcc00;background:transparent;
      color:#ffcc00;border-radius:10px;cursor:pointer}

    /* Clock (top-right) */
    #clock{
      position:fixed; top:12px; right:20px;
      font-size:1.6rem; letter-spacing:1px;
      background:rgba(0,0,0,0.25);
      padding:6px 12px; border-radius:10px;
    }
  </style>
</head>
<body>
  <h1>✈ Departures</h1>

  <!-- Clock -->
  <div id="clock" aria-label="Current time">--:--:--</div>

  <table id="departures">
    <colgroup>
      <col class="time" />
      <col class="party" />
      <col class="status" />
    </colgroup>
    <thead>
      <tr><th>Time</th><th>Party</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Flip sound -->
  <audio id="flipSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <!-- Tap once to enable the flip sound (some browsers block autoplay) -->
  <div id="soundGate" aria-label="Enable sound">
    <div class="wrap">
      <div>Press OK to enable flip sound</div>
      <button id="enableSoundBtn">Enable Sound</button>
    </div>
  </div>

  <script>
    // ===== Settings =====
    const SHEET_URL = "https://opensheet.elk.sh/1C30nrkK_fqBK7i9c8_kABHPWkdETjaGMY3PyOifOI6k/1";
    const BOARDING_SOON_BEFORE = 15;     // mins before start
    const NOW_BOARDING_BEFORE = 10;      // mins before start (-> Now Boarding)
    const CLOSED_AFTER = 10;             // mins after start (-> Closed)
    const HIDE_AFTER_MINUTES = 120;      // after 2 hours -> enter celebration
    const CELEBRATE_MINUTES = 15;        // show "Landed / Happy Birthday" for 15 min
    const REFRESH_MS = 60000;            // refresh every 60s

    const flipSound = document.getElementById("flipSound");

    // ===== Helpers =====
    const clean = s => String(s||"").replace(/\u202F|\u00A0/g," ").replace(/â€¯/g," ").trim();

    function ordinal(n){
      const x = parseInt(n,10);
      if ([11,12,13].includes(x % 100)) return x + "th";
      const last = x % 10;
      return x + (last===1?"st":last===2?"nd":last===3?"rd":"th");
    }

    function ymd(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    // Accept YYYY-MM-DD, or MM/DD[/YY|YYYY], or DD/MM[/YY|YYYY] (match today only)
    function dateIsTodayAndReturn(raw){
      const t = clean(raw);
      if (!t) return null;

      const today = new Date();
      const todayKey = ymd(new Date(today.getFullYear(), today.getMonth(), today.getDate()));

      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(t)) {
        const [Y,M,D] = t.split("-").map(n=>parseInt(n,10));
        const d = new Date(Y, M-1, D);
        return (ymd(d)===todayKey) ? d : null;
      }
      const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m){
        let a = parseInt(m[1],10), b = parseInt(m[2],10), c = parseInt(m[3],10);
        if (c < 100) c += 2000;
        const dUS = new Date(c, a-1, b); if (ymd(dUS)===todayKey) return dUS; // MM/DD
        const dEU = new Date(c, b-1, a); if (ymd(dEU)===todayKey) return dEU; // DD/MM
      }
      return null;
    }

    function parseTimeOnDate(timeStr, dateObj){
      const s = clean(timeStr).toUpperCase();
      const rx = /^(\d{1,2}):(\d{2})\s*(AM|PM)?$/;
      const m = s.match(rx);
      let hh=0, mm=0;
      if (m){
        hh = parseInt(m[1],10); mm = parseInt(m[2],10);
        const ap = m[3];
        if (ap==="PM" && hh!==12) hh+=12;
        if (ap==="AM" && hh===12) hh=0;
      } else {
        const [H,Mi] = s.split(":").map(n=>parseInt(n,10)||0);
        hh = H; mm = Mi;
      }
      return new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), hh, mm, 0, 0);
    }

    function computeStatus(when, now){
      const minutesTo = (when - now) / 60000;   // >0 before start, <0 after start
      const minutesSince = -minutesTo;

      // Celebration window: 2h to 2h15 after start
      if (minutesSince >= HIDE_AFTER_MINUTES && minutesSince <= HIDE_AFTER_MINUTES + CELEBRATE_MINUTES){
        return { text: "Celebration", cls: "status-celebrate", kind: "celebrate" };
      }

      if (minutesTo > BOARDING_SOON_BEFORE)   return { text: "On Time",       cls: "",             kind: "on_time" };
      if (minutesTo > NOW_BOARDING_BEFORE)    return { text: "Boarding Soon", cls: "",             kind: "boarding_soon" };
      if (minutesTo >= -CLOSED_AFTER)         return { text: "Now Boarding",  cls: "status-now",   kind: "now_boarding" };
      return { text: "Closed",                cls: "status-closed",           kind: "closed" };
    }

    // Status sorting priority: Now Boarding (0) → Boarding Soon (1) → Closed (2) → Celebration (3) → On Time (4)
    function statusPriority(kind){
      if (kind === "now_boarding")   return 0;
      if (kind === "boarding_soon")  return 1;
      if (kind === "closed")         return 2;
      if (kind === "celebrate")      return 3; // <-- celebration above on time
      if (kind === "on_time")        return 4;
      return 5;
    }

    let celebrateNodes = []; // live references to celebration status spans
    let celebrateToggle = false;

    async function loadData(){
      const res = await fetch(SHEET_URL);
      const data = await res.json();

      const now = new Date();
      const rows = [];

      for (const r of data){
        const d = dateIsTodayAndReturn(r.Date);
        if (!d) continue; // only today's entries

        const when = parseTimeOnDate(r.Time, d);
        const minutesSince = (now - when) / 60000;

        // Keep rows up to 2h15 after start; hide after that
        if (minutesSince > HIDE_AFTER_MINUTES + CELEBRATE_MINUTES) continue;

        const s = computeStatus(when, now);

        rows.push({
          when,
          time: clean(r.Time),
          name: clean(r.Name),
          age: clean(r.Age),
          statusText: s.text,
          statusClass: s.cls,
          statusKind: s.kind,
          statusOrder: statusPriority(s.kind)
        });
      }

      // Sort by status group first, then by time ascending
      rows.sort((a,b)=>{
        if (a.statusOrder !== b.statusOrder) return a.statusOrder - b.statusOrder;
        return a.when - b.when;
      });

      const tbody = document.querySelector("#departures tbody");
      tbody.innerHTML = "";
      celebrateNodes = []; // reset

      rows.forEach((item, i) => {
        const partyText = `${item.name}'s ${ordinal(item.age)} Birthday`;

        const tr = document.createElement("tr");
        // Celebration rows flip between messages (no emoji)
        const statusSpan = (item.statusKind === "celebrate")
          ? `<span class="flap ${item.statusClass} celebrate-text">${celebrateToggle ? "Happy Birthday!" : "Landed"}</span>`
          : `<span class="flap ${item.statusClass}">${item.statusText}</span>`;

        tr.innerHTML = `
          <td><span class="flap">${item.time}</span></td>
          <td><span class="flap">${partyText}</span></td>
          <td>${statusSpan}</td>
        `;

        setTimeout(()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch{} }, i*250);
        tbody.appendChild(tr);

        if (item.statusKind === "celebrate") {
          const node = tr.querySelector(".celebrate-text");
          if (node) celebrateNodes.push(node);
        }
      });
    }

    // Initial + repeat refresh
    loadData();
    setInterval(loadData, REFRESH_MS);

    // One-tap gate to enable the flip sound (autoplay policies)
    document.getElementById('enableSoundBtn').addEventListener('click', async () => {
      try { await flipSound.play(); flipSound.pause(); flipSound.currentTime = 0; } catch {}
      document.getElementById('soundGate').remove();
    });

    // ===== Clock =====
    function updateClock(){
      const now = new Date();
      const t = now.toLocaleTimeString('en-GB', { hour12:false });
      document.getElementById('clock').textContent = t;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ===== Celebration flasher (toggle text every ~1.5s) =====
    setInterval(()=>{
      celebrateToggle = !celebrateToggle;
      const text = celebrateToggle ? "Happy Birthday!" : "Landed";
      for (const el of celebrateNodes) el.textContent = text;
    }, 1500);
  </script>
</body>
</html>
